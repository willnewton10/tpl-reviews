<!doctype html>
<html>
  <head>
    <title>TPL Reviews</title>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
 
  </head>
  <body>
    <h1>TPL Reviews</h1>
    <form id='search'>
      <input name='keywords' />
      <button type='submit'>Search</button>
    </form>
    <div id="results">
    </div>

    <script>
      $('form').submit(function (e) {
        e.preventDefault();
        var data = $('form').serialize();
        console.log("data", data);
        search(data);
        return false;
      });

      function search (querystring) {
        console.log(querystring);
        $.getJSON("/api/tpl", querystring, function (books) {
          console.log(books);
          displayBooks(books);
        });
      }

      function displayBooks(books) {
        $('#results').html('');
        books.forEach(function (book, i) {
          $('#results').append("<div id='book"+i+"' class='result'>" +
	    "<h4>" + book.title + "</h4>" + 
	    book.author + "," + book.date + "," + book.holds + 
	    book.copies + "<img src='"+book.image+"' />" + 
	    "</div>");
            getReviews(book, "book"+i);
        });
      }

      function getReviews (book, id) {
         var data = { keywords: book.title + " " + book.author };
         $.getJSON("/api/amzn", data, function (reviews) {
           console.log("amazon reviews", reviews);
           displayReviews(reviews, id);
         });
      }

      function displayReviews(reviews, id) {
        reviews.slice(0,3).forEach(function (rev) {
          $("#"+id).append("<div>" + rev.title + ": " + 
	    "STARS: " + rev.stars + "</div>");
          });
      }
    </script>
  </body>
</html>
